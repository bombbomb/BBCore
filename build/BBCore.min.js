/*! BBCore 2020-11-30 */
function BBCore(e){this.userEmail="",this.userId="",this.clientId="",this.accessToken="",this.currentVideoId=null,this.email=null,this.apiServer=null,this.credentials={clientIdentifier:null,redirectUri:null,clientSecret:null,type:"implicit"},this.onerror=null,this.__mergeProperties(null,e),this.authenticated=!1,this.hasContext=!1,this.storage=localStorage||window.storage,this.CONTENT={QUICKSEND:""},this.lastresponse="",this.__vidRecording=!1,this.__vidRecHndl=null,this.contacts=function(){},this.contacts.prototype=Object.create(Array.prototype),this.contacts.constructor=this.contacts,this.contacts.prototype.add=function(e){return this.push(e),this},this.contacts.prototype.find=function(e,t){for(var o in this)if(this.hasOwnProperty(o)&&o[e]===t)return o;return null},this.contacts.prototype.get=function(e){return this.find("id",e)},this.videos=function(){},this.videos.prototype=Object.create(Array.prototype),this.videos.constructor=this.videos,this.videos.prototype.add=function(e){return this.push(e),this},this.accessToken&&this.validateAccessToken(),this.email&&this.password&&this.login(this.email,this.password)}function responseSuccess(e,t){}"function"!=typeof Object.create&&(Object.create=function(e,t){if("object"!=typeof e&&"function"!=typeof e)throw new TypeError("Object prototype may only be an Object: "+e);if(null===e)throw new Error("This browser's implementation of Object.create is a shim and doesn't support 'null' as the first argument.");if(void 0!==t)throw new Error("This browser's implementation of Object.create is a shim and doesn't support a second argument.");function o(){}return o.prototype=e,new o}),BBCore.CONFIG={VERSION:"1.0",API_END_POINT:"/app/api/api.php",SERVER_API_URL:"https://app.bombbomb.com",OAUTH_STORAGE:"authToken"},BBCore.prototype.__mergeProperties=function(e,t){for(var o in e||(e=this),t)o&&t.hasOwnProperty(o)&&(e[o]=e[o]&&"object"==typeof e[o]?this.__mergeProperties(e[o],t[o]):t[o]);return e},BBCore.prototype.onError=function(e,t){"function"==typeof e?this.onerror=e:this.onerror&&this.onerror.call(this,e,t)},BBCore.prototype.ver=function(){return BBCore.CONFIG.VERSION},BBCore.prototype.getServerUrl=function(){return this.apiServer||BBCore.CONFIG.SERVER_API_URL},BBCore.prototype.getRequestUrl=function(){return this.getServerUrl()+BBCore.CONFIG.API_END_POINT},BBCore._addParameterToUrl=function(e,t,o){var i="?";return-1!==e.indexOf("?")&&(i="&"),e+i+t+"="+o},BBCore.prototype.sendRequest=function(e,t,o,i){if("function"==typeof t&&(o=t),"object"==typeof e&&(t=e),"object"==typeof e&&t.method&&(e=t.method),"string"!=typeof e||t.method||(t.method=e),"IsValidLogin"===e||t.api_key||(t.api_key=this.getKey()),"ValidateSession"!==e&&"authorization_code"!==t.grant_type&&!this.authenticated)return this.onError.call(this,{status:"failure",methodName:"InvalidSession",info:{errormsg:"Invalid login"}},null),!1;var n={},r=this,s=!0;void 0!==t.async&&(s=t.async);var d=this.getOAuthTokenForRequest();d&&d.length?(n.Authorization=d,void 0!==t.api_key&&delete t.api_key):this.isAccessToken(t.api_key)&&(n.Authorization=t.api_key,delete t.api_key);var a=t.url?t.url:this.getRequestUrl();a=BBCore._addParameterToUrl(a,"xsrc","bbcore-"+BBCore.CONFIG.VERSION);let c=new FormData;Object.keys(t).forEach((e=>{c.append(e,t[e])}));const h=new XMLHttpRequest;h.open("POST",a,s),Object.keys(n).forEach((e=>{h.setRequestHeader(e,n[e])})),h.onload=i=>{const n=JSON.parse(i.target.response);4===h.readyState&&200===h.status?"success"===n.status?("GetVideoGuid"===e&&n.info&&n.info.video_id&&(r.currentVideoId=n.info.video_id),o&&o.call(r,n)):"authorization_code"===t.grant_type||"refresh_token"===t.grant_type?o.call(r,n):r.onError.call(r,n):r.onError.call(r,n)},h.onerror=e=>{let t={status:"unknown",jqXHR:e};void 0!==e.responseJSON&&(t=e.responseJSON),r.lastresponse=t.status,"success"===t.status?o.call(r,t,e):r.onError.call(r,t,e),i&&i(r,t)},h.send(c)},BBCore.prototype.login=function(e,t,o){if(arguments.length<2&&this.credentials&&this.credentials.clientIdentifier){var i=window;"undefined"!=typeof usePopup&&(i=window.open("about:blank","_blank")),i.location=this.getOAuthUrl()}else{if("function"==typeof e&&(o=e,e=this.storage.getItem("b2-uid"),t=this.storage.getItem("b2-pwd")),!e&&!this.accessToken)return void this.onError({info:{errormsg:"Username cannot be blank"}});this.userEmail=e;var n=this;this.sendRequest({method:"ValidateSession",email:e,pw:t,jwt:!0},(function(e){n.__updateSession(e,o)}))}},BBCore.prototype.logout=function(){this.clearJsonWebToken(),this.clearOAuthToken(),this.clearKey(),this.storage.removeItem("b2-uid"),this.storage.removeItem("b2-pwd"),this.accessToken="",this.hasContext=!1,this.authenticated=!1},BBCore.prototype.credentialsSaved=function(){return null!==this.storage.getItem("b2-uid")||null!==this.storage.getItem("access_token")||null!==this.storage.getItem("jsonWebToken")||null!==localStorage.getItem("authToken")},BBCore.prototype.saveCredentials=function(e,t){this.storage.setItem("b2-uid",e)},BBCore.prototype.validateSession=function(e,t){var o=this.getOAuthPayload(),i=this,n=/[\?\#].*&*(access_token|code)=([^&]+)/gi.exec(window.location);if(n&&n.length>1){var r=n[2];if("code"===n[1])this.validateOAuthCode(decodeURIComponent(r),(function(e){this.storeOAuthTokens(e),window.location.href="?code"===n[0].substr(0,5)?window.location.href.replace("?code="+r,""):window.location.href.replace("&code="+n[1],"")}),t);else{for(var s={access_token:r,token_type:null,expires_in:null},d=window.location.hash.replace("access_token="+r,""),a=null;a=/\&*(token_type|expires_in)=([^&]+)/gi.exec(window.location.hash);)s[a[1]]=a[2],d=d.replace(a[0],""),window.location.hash=d.length>1?d:"";this.authenticated=!0,this.storeOAuthTokens(s),e.call(i)}}else if(this.isOAuthTokenValid(o)){var c=this.__getOAuthAccessPayload(o);this.__updateSession({status:"success",info:{clientId:c.bbcid,userId:c.sub}},(function(){e.call(i)}))}else!this.getKey()&&this.getJsonWebToken()?this.verifyJsonWebToken((function(t){i.__updateSession(t),e.call(i,t)})):this.credentials&&this.credentials.clientIdentifier?t&&t():this.getKey()?this.validateAccessToken(e):this.storage.getItem("b2-uid")?this.login(e):t&&t()},BBCore.prototype.getOAuthUrl=function(){var e=null,t=this.credentials;return t.clientIdentifier&&t.redirectUri&&(e=this.getServerUrl()+"/auth/authorize?client_id="+t.clientIdentifier+"&scope="+encodeURIComponent(t.scope?t.scope:"all:manage")+"&redirect_uri="+encodeURIComponent(t.redirectUri)+"&response_type="+("implicit"===t.type?"token":"code")),e},BBCore.prototype.resumeStoredSession=BBCore.prototype.validateSession,BBCore.prototype.validateAccessToken=function(e){var t=this;this.sendRequest({method:"ValidateSession",api_key:this.accessToken,async:!1,jwt:!0},(function(o){t.__updateSession(o,e)}))},BBCore.prototype.isAccessToken=function(e){return"string"==typeof e&&e.length>32&&e.indexOf(".")>-1},BBCore.prototype.isAuthenticated=function(){return this.authenticated||console.log("You must authenticate a BombBomb session before making additional calls."),this.authenticated},BBCore.prototype.invalidateSession=function(){try{this.logout()}catch(e){return!1}return!0},BBCore.prototype.__updateSession=function(e,t){"success"===e.status&&(e.info.userId?(this.userId=e.info.userId,this.clientId=e.info.clientId):(this.userId=e.info.user_id,this.clientId=e.info.client_id),e.info.api_key&&(this.accessToken=e.info.api_key),this.hasContext=!0,this.authenticated=!0,this.storeKey(this.accessToken),this.storeJsonWebToken(e.info.jwtoken),console.log("bbcore: __updateSession session updated."),t&&t.call(this,e))},BBCore.prototype.verifyKey=function(e,t){this.sendRequest({method:"GetEmails",api_key:e},(function(e){t&&t({isValid:"success"===e.status})}))},BBCore.prototype.storeKey=function(e){e&&(this.accessToken=e,this.storage.setItem("access_token",this.accessToken))},BBCore.prototype.getKey=function(){return this.accessToken?this.accessToken:this.storage.getItem("access_token")},BBCore.prototype.clearKey=function(){this.accessToken=null,this.storage.removeItem("access_token")},BBCore.prototype.verifyJsonWebToken=function(e,t){"function"==typeof e&&(t=e,e=this.getJsonWebToken()),this.sendRequest({method:"ValidateJsonWebToken",jwt:e},(function(e){t&&(e.isValid="success"===e.status,t(e))}))},BBCore.prototype.storeOAuthTokens=function(e){if(e)try{e="string"==typeof e?e:JSON.stringify(e),this.storage.setItem(BBCore.CONFIG.OAUTH_STORAGE,btoa(e))}catch(e){}},BBCore.prototype.getOAuthPayload=function(){var e=this.storage.getItem(BBCore.CONFIG.OAUTH_STORAGE);return e?atob(e):null},BBCore.prototype.getOAuthTokenForRequest=function(){var e=null;try{var t=this.getOAuthPayload();if(t&&this.isOAuthTokenValid(t)){var o=JSON.parse(t);"object"==typeof o&&(e=o.token_type.substr(0,1).toUpperCase()+o.token_type.substr(1)+" "+o.access_token)}}catch(e){console.error("Exception occurred retrieving OAuth Token for Request",e)}return e},BBCore.prototype.clearOAuthToken=function(){this.authenticated=!1,this.storage.removeItem(BBCore.CONFIG.OAUTH_STORAGE)},BBCore.prototype.__getOAuthAccessPayload=function(e){var t="string"==typeof e?JSON.parse(e):e,o=null;if(t)try{var i=t.access_token.split(".");i.length>2&&(o=JSON.parse(atob(i[1])))}catch(e){console.warn("Exception __getOAuthAccessPayload fetching access_token payload",e)}return o},BBCore.prototype.isOAuthTokenValid=function(e){var t=!1;try{var o=this.__getOAuthAccessPayload(e);o&&new Date(o.exp)<Date.now()&&(t=!0)}catch(e){console.warn("Exception while validating OAuthToken",e)}return t},BBCore.prototype.validateOAuthCode=function(e,t,o){var i=this,n=this.credentials,r={url:this.getServerUrl()+"/auth/access_token",grant_type:n.type||"implicit",client_id:n.clientIdentifier,redirect_uri:n.redirectUri,code:JSON.stringify(e)};if("implicit"!==n.type){if(!n.clientSecret||!n.clientSecret){var s="Client Secret required when making "+n.type+" grant requests";return console.warn(s),void o.call(this,s)}r.client_secret=n.clientSecret}this.sendRequest(r,(function(e){e&&this.isOAuthTokenValid(e)?(this.authenticated=!0,this.storeOAuthTokens(e),t&&t.call(i)):o&&o.call(i)}))},BBCore.prototype.refreshOAuthToken=function(e){var t=this.credentials,o={url:this.getServerUrl()+"/auth/access_token",grant_type:"refresh_token",refresh_token:this.getOAuthRefreshToken(),client_id:t.clientIdentifier,client_secret:t.clientSecret,redirect_uri:t.redirectUri,code:JSON.stringify(authCode)};this.sendRequest(o,(function(t){console.log("got refresh auth back",t),t&&(this.isOAuthTokenValid(t)&&(this.authenticated=!0),this.storeOAuthTokens(t),e&&e())}))},BBCore.prototype.storeJsonWebToken=function(e){e&&(this.jsonWebToken=e,this.storage.setItem("jsonWebToken",this.jsonWebToken))},BBCore.prototype.getJsonWebToken=function(){return this.jsonWebToken?this.jsonWebToken:this.storage.getItem("jsonWebToken")},BBCore.prototype.clearJsonWebToken=function(){this.jsonWebToken=null,this.storage.removeItem("jsonWebToken")},BBCore.prototype.getValidJsonWebTokenAsync=function(e){var t=this.getJsonWebToken();t||!e?this.verifyJsonWebToken(t,(function(o){o&&o.isValid?e&&e(t):this.validateAccessToken((function(t){e&&(o?(this.storeJsonWebToken(t.jwtoken),e(this.getJsonWebToken())):e(null))}))})):e(null)},BBCore.prototype.getLists=function(e){this.sendRequest({method:"GetLists"},e)},BBCore.prototype.createList=function(e,t){this.sendRequest({method:"createList",name:e},t)},BBCore.prototype.getContact=function(e,t){if(e){var o={width:340,force_ssl:!1,contact_id:e,method:"GetContact"};this.sendRequest(o,t)}},BBCore.prototype.getListContacts=function(e,t){e&&this.sendRequest({method:"GetListContacts",list_id:e},t)},BBCore.prototype.addContact=function(e,t){"object"==typeof e&&(e.method="AddContact",this.sendRequest(e,t))},BBCore.prototype.bulkAddContacts=function(e,t){e||(e={}),e.method="BulkAddContacts","object"==typeof e.contacts&&(e.contacts=JSON.stringify(e.contacts)),this.sendRequest(e,t)},BBCore.prototype.updateContact=function(e,t){e&&(e.method="UpdateContact",this.sendRequest(e,t))},BBCore.prototype.getImportAddressesByType=function(e,t){(e={...e,method:"getImportAddressesByType"}).type||this.onError({info:{errmsg:["A Type must be provided."]}}),this.sendRequest(e,t)},BBCore.prototype.addContactImportAddress=function(e,t){(e={opts:e,method:"addContactImportAddress"}).importAddrCode&&e.importAddrName||this.onError({info:{errmsg:["An Import Address Code and Import Address Name must be provided."]}}),this.sendRequest(e,t)},BBCore.prototype.deleteContactImportAddress=function(e,t){(e={...e,importAddrCode:1,method:"deleteContactImportAddress"}).importAddrCode||this.onError({info:{errmsg:["Invalid Import Address Code"]}}),this.sendRequest(e,t)},BBCore.prototype.getEmails=function(e){this.sendRequest({method:"GetEmails"},e)},BBCore.prototype.sendCustomVideoEmail=function(e,t){var o={method:"SendCustomVideoEmail",html_content:null,subject:"",email:"",email_id:"",from_name:"",...e};this.sendRequest(o,t)},BBCore.prototype.getDrips=function(e,t){(e=e||{}).method="GetDrips",this.sendRequest(e,t)},BBCore.prototype.getForms=function(e,t){(e=e||{}).method="GetForms",this.sendRequest(e,t)},BBCore.prototype.getClientIntegrations=function(e,t){"function"==typeof e&&(t=e,e={}),e.method="getClientIntegrations",this.sendRequest(e,t)},BBCore.contact=function(e){for(var t in this.email="",this.firstname="",this.lastname="",this.phone="",this.phone_number="",this.address_line_1="",this.address_line_2="",this.city="",this.state="",this.country="",this.postal_code="",this.company="",this.position="",this.comments="",this.listlist="",this.id="",e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.eml=this.email},BBCore.video=function(e){for(var t in this.vid_id="",this.title="",this.filename="",e)e.hasOwnProperty(t)&&(this[t]=e[t])},BBCore.prototype.getVideoDeliveryUrl=function(e){return e={video_id:"",autoplay:1,...e},"http://"+(this.getServerUrl().indexOf("dev")>0?"dev.":this.getServerUrl().indexOf("local")>0?"local.":"")+"bbemaildelivery.com/bbext/?p=video_land&id="+e.video_id+"&autoplay="+e.autoplay},BBCore.prototype.getVideo=function(e,t){e&&this.sendRequest({method:"GetVideos",video_id:e},t)},BBCore.prototype.getVideos=function(e,t){"function"==typeof e&&(t=e,e={});var o={updatedSince:"",page:null,pageSize:50,...e};if("object"==typeof o&&null!=o&&void 0!==o.pageSize&&(null==o.pageSize||o.pageSize<=0||isNaN(o.pageSize)))return!1;o.method="GetVideos",null!==o.page&&o.pageSize&&(o.method="GetVideosPaged"),this.sendRequest(o,t)},BBCore.prototype.getVideoStatus=function(e,t){e&&this.sendRequest({method:"getVideoStatus",id:e},t)},BBCore.prototype.getEncodingReport=function(e,t){e&&this.sendRequest({method:"getEncodingReport",id:e},t)},BBCore.prototype.deleteVideo=function(e,t){this.sendRequest({method:"DeleteVideo",videoId:e},t)},BBCore.prototype.setVideoId=function(e){this.currentVideoId=e},BBCore.prototype.getVideoId=function(e){this.currentVideoId?e&&e.call(this,this.currentVideoId):this.getNewVideoGuid(e)},BBCore.prototype.hasVideoId=function(){return!!this.currentVideoId},BBCore.prototype.getNewVideoGuid=function(e){var t=this;this.sendRequest({method:"GetVideoGuid"},(function(o){t.currentVideoId=o.info.video_id,e&&e.call(this,t.currentVideoId)}))},BBCore.prototype.videoQuickSend=function(e,t){var o={method:"VideoQuickSend",subject:"QuickSend from BombBomb",mobile_message:"",email_address:null,videoId:null},i=[];for(var n in o)o.hasOwnProperty(n)&&(e[n]||(e[n]=o[n]));e.message&&!e.mobile_message&&(e.mobile_message=e.message),e.email&&!e.email_address&&(e.email_address=e.email),e.email_address&&!e.email_addresses&&(e.email_addresses=e.email_address),!e.video_id&&this.currentVideoId&&(e.video_id=this.currentVideoId,e.videoId=this.currentVideoId),e.video_id||i.push("quickSendVideo Error: no video_id defined."),e.email_addresses||i.push("quickSendVideo Error: no email_address defined."),i.length>0&&!e.video_id?this.getVideoId((function(o){o?(e.video_id=o,this.sendRequest(e,t)):(i.push("quickSendVideo: Terminal Error: Unable to set video_id"),this.onError({info:{errmsg:i}}))})):this.sendRequest(e,t)},BBCore.prototype.getEmbeddedRecorderUrl=function(e,t){"function"==typeof e&&(t=e,e={});void 0===e.height&&(e={height:240,width:320,force_ssl:!1,...e});var o={...e,module:"videos",page:"EmbeddedRecorder",popup:1,nohtml:1},i=this;this.getVideoId((function(n){var r=i.getServerUrl()+"/app/?",s=i.getKey();ignoreLegacyToken=e.ignoreLegacyToken||!1,s&&s.length&&!ignoreLegacyToken?(o.api_key=s,r+="module=login&actn=login&api_key="+s+"&redir="+btoa(r+Object.keys(o).map((e=>e+"="+encodeURIComponent(o[e]))).join("&")+(n?"&vguid="+n:"")),t.call(this,{url:r,video_id:n})):(e.videoId=n,this.getVideoRecorder(e,(function(e){var o="";e&&e.info&&e.info.content.length&&(o=/https*:\/\/[^<"]+/.exec(e.info.content)[0]);t({url:o,video_id:n})})))}))},BBCore.prototype.getVideoRecorder=function(e,t){"function"==typeof e&&(t=e,e=null);mergedOpts={height:240,width:320,force_ssl:!1,start:null,stop:null,recorded:null,...e},this.isAuthenticated()?(mergedOpts.method="GetVideoRecorder",this.sendRequest(mergedOpts,(function(e){t&&t.call(this,e)}))):this.onError({message:"Must authenticate session before invoking methods."})},BBCore.prototype.startVideoRecorder=function(e,t){if("function"==typeof e&&(t=e,e=null),(e=e||{type:"embedded",target:null,height:240,width:320,force_ssl:!1,recorderLoaded:null,recordComplete:t}).recordComplete&&!t&&(t=e.recordComplete),e.target)this.__vidRecHndl=document.querySelector(e.target);else{const e=document.createElement("div");e.id="b2recorder",this.__vidRecHndl=document.querySelector("body").appendChild(e)}var o={...e};delete o.type,delete o.target,delete o.recordComplete,delete o.recorderLoaded;var i=this;this.getVideoRecorder(o,(function(t){i.currentVideoId=t.info.vid_id,console.log("startVideoRecorder :"+i.currentVideoId),window.jQuery?(this.__vidRecHndl=e.target?jQuery(e.target):jQuery("body").append('<div id="b2recorder"></div>'),i.__vidRecHndl.html(t.info.content)):(window.addEventListener("message",(function(e){if(~e.origin.indexOf("app.bombbomb.com"))if("reportVideoRecorded"==e.data.action)window.reportVideoRecorded(e.data.flname,e.data.log);else if("iframeResize"==e.data.action){var t=document.getElementById(i.currentVideoId),o=parseInt(t.clientWidth,10)||parseInt(t.width,10),n=parseInt(t.style.width,10);o&&o>n||isNaN(n)?t.style.height=o*e.data.ratio+"px":n&&(t.style.height=n*e.data.ratio+"px")}})),i.__vidRecHndl.innerHTML=t.info.content),e.recorderLoaded&&e.recorderLoaded.call(i,t.info)})),window.bbStreamStartRecord=function(e,t){console.log("bbStreamStartRecord triggered"),i.liveStreamStartRecord.call(i,e,t)},window.bbStreamStopRecord=function(e){console.log("bbStreamStopRecord triggered"),i.liveStreamStopRecord.call(i,e)},window.reportVideoRecorded=function(e,o){console.log("reportVideoRecorded triggered"),t({videoId:i.currentVideoId,filename:e,log:o})}},BBCore.prototype.destroyVideoRecorder=function(){void 0!==this.__vidRecHndl&&this.__vidRecHndl.remove(),window.bbStreamStartRecord=null,window.bbStreamStopRecord=null,window.reportVideoRecorded=null},BBCore.prototype.liveStreamStartRecord=function(e,t){this.__vidRecording=!0,this.sendRequest({method:"liveStreamStartRecord",streamname:e,filename:t})},BBCore.prototype.liveStreamStopRecord=function(e){this.__vidRecording=!1,this.sendRequest({method:"liveStreamStopRecord",streamname:e})},BBCore.prototype.saveRecordedVideo=function(e,t,o,i){var n=t||this.currentVideoId,r=this;this.sendRequest({method:"VideoRecordedLive",title:e,filename:o,vid_id:n},(function(e){i.call(r,e)}))},BBCore.prototype.saveRecording=function(e){var t=e;t.vid_id&&this.sendRequest({method:"VideoRecordedLive"},t,(function(){}))};